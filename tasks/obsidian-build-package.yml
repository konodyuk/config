---
- name: get mdate of source - {{ item }}
  stat:
    path: '{{ ansible_env.PWD }}/obsidian/own-packages/{{ item }}/main.ts'
  register: source_stat

- name: get mdate of build - {{ item }}
  stat:
    path: '{{ ansible_env.PWD }}/obsidian/own-packages/{{ item }}/main.js'
  register: build_stat

- name: build - {{ item }}
  command: "npm run rebuild-cleanup"
  args:
    chdir: '{{ ansible_env.PWD }}/obsidian/own-packages/{{ item }}'
  when: source_stat.stat.mtime > build_stat.stat.mtime

- name: ensure plugin dir - {{ item }}
  file:
    path: '{{ ansible_env.PWD }}/obsidian/plugins/{{ item }}'
    state: directory

- name: copy built sources - {{ item }}
  copy:
    src: '{{ ansible_env.PWD }}/obsidian/own-packages/{{ item }}/{{ filename }}'
    dest: '{{ ansible_env.PWD }}/obsidian/plugins/{{ item }}/{{ filename }}'
  loop_control:
    loop_var: filename
  loop:
    - manifest.json
    - main.js
